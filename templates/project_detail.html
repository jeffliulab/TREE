<!-- templates/project_detail.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é¡¹ç›®è¯¦æƒ… | Tree ç§å¯†é¡¹ç›®</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      font-family:"Segoe UI","Helvetica Neue",sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:2em;
    }
    .container {
      max-width:700px;
      margin:auto;
      background:#fff;
      padding:2em;
      border-radius:10px;
      box-shadow:0 0 10px rgba(0,0,0,0.05);
    }
    h2 {
      font-size:1.5em;
      color:#333;
      margin-bottom:1em;
    }
    .project-info p {
      margin:0.5em 0;
      color:#666;
    }
    .project-info input[type="text"],
    .project-info textarea {
      width:100%;
      padding:0.6em;
      margin-bottom:1em;
      border:1px solid #ccc;
      border-radius:6px;
      box-sizing:border-box;
      font-family:inherit;
    }
    .project-info button {
      padding:0.5em 1em;
      font-size:1em;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .project-info button:hover {
      background:#eee;
    }
    hr {
      margin:2em 0;
      border:none;
      border-top:1px solid #eee;
    }
    ul {
      list-style:none;
      padding:0;
    }
    li {
      display:flex;
      align-items:center;
      margin-bottom:0.75em;
    }
    li form,
    li span,
    li input,
    li button {
      margin-right:0.5em;
    }
    /* é»˜è®¤éšè—è¾“å…¥æ¡†ï¼Œç”± JS æ˜¾ç¤º */
    li .task-input {
      flex:1;
      padding:0.5em;
      border:1px solid #ccc;
      border-radius:6px;
      display:none;
    }
    li .task-label {
      flex:1;
    }
    .nav {
      margin-top:2em;
    }
    .nav a {
      margin-right:1em;
      color:#663399;
      text-decoration:none;
    }
    .nav a:hover {
      text-decoration:underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ é¡¹ç›®è¯¦æƒ…</h2>

    <!-- â€”â€” é¡¹ç›®æ ‡é¢˜ & ç®€ä»‹åŒºåŸŸ â€”â€” -->
    <div class="project-info">
      <!-- åªè¯»æ€ -->
      <div class="info-view">
        <h3 class="proj-title">{{ project[0] }}</h3>
        <p class="proj-desc">{{ project[1] or 'ï¼ˆæš‚æ— æè¿°ï¼‰' }}</p>
        <button type="button" class="edit-project-btn">âœï¸ ä¿®æ”¹</button>
        <p>åˆ›å»ºäº {{ project[2] }}</p>
      </div>

      <!-- 2025/7/1ä¿®æ”¹æ›´æ–°è¿™ä¸€éƒ¨åˆ†ï¼Œå¢åŠ äº†PRIORITY -->
      <!-- ç¼–è¾‘æ€ï¼ˆåˆå§‹éšè—ï¼‰ -->
      <!-- <form method="POST" class="info-edit" style="display:none;">
        <input type="text" name="update_title" value="{{ project[0] }}" required>
        <textarea name="update_description" rows="3"
          placeholder="é¡¹ç›®ç®€ä»‹ï¼ˆå¯ä¸ºç©ºï¼‰">{{ project[1] }}</textarea>
        <button type="submit">âœ”ï¸ å®Œæˆ</button>
      </form> -->

      <!-- 2025/7/1ä¿®æ”¹æ›´æ–°è¿™ä¸€éƒ¨åˆ†ï¼Œå¢åŠ äº†PRIORITY -->
      <form method="POST" class="info-edit" style="display:none;">
        <input type="text" name="update_title" value="{{ project[0] }}" required>
        <textarea name="update_description" rows="3"
          placeholder="é¡¹ç›®ç®€ä»‹ï¼ˆå¯ä¸ºç©ºï¼‰">{{ project[1] }}</textarea>
          
        <div style="margin-bottom:1em;">
            <label for="update_priority">ä¼˜å…ˆçº§: </label>
            <select name="update_priority" id="update_priority">
                <option value="S" {% if project[4] == 'S' %}selected{% endif %}>S (æœ€é«˜)</option>
                <option value="A" {% if project[4] == 'A' %}selected{% endif %}>A</option>
                <option value="B" {% if project[4] == 'B' %}selected{% endif %}>B</option>
                <option value="C" {% if project[4] == 'C' %}selected{% endif %}>C</option>
                <option value="Z" {% if project[4] == 'Z' %}selected{% endif %}>Z (æœ€ä½)</option>
            </select>
        </div>
        <button type="submit">âœ”ï¸ å®Œæˆ</button>
    </form>
    </div>

    <hr>

    <!-- â€”â€” å­ä»»åŠ¡åŒºåŸŸ â€”â€” -->
    <h3>ğŸ“‹ å­ä»»åŠ¡ (å…± {{ tasks|length }} æ¡)</h3>
    <form method="POST" style="display:flex; margin-bottom:1em;">
      <input type="text" name="new_task" placeholder="æ·»åŠ æ–°ä»»åŠ¡â€¦" style="flex:1;">
      <button type="submit">â•</button>
    </form>
    <ul>
      {% for tid, task_text, done, created_at in tasks %}
        <li data-task-id="{{ tid }}">
          <!-- åˆ‡æ¢å®ŒæˆçŠ¶æ€ -->
          <form method="POST">
            <input type="hidden" name="toggle" value="{{ tid }}">
            <button type="submit">
              {% if done %}âœ…{% else %}â˜{% endif %}
            </button>
          </form>

          <!-- åªè¯»æ ‡ç­¾ -->
          <span class="task-label"
                style="{% if done %}color:#888;text-decoration:line-through;{% endif %}">
            {{ task_text }}
          </span>

          <!-- ç¼–è¾‘è¾“å…¥æ¡†ï¼ˆéšè—ï¼‰ -->
          <input type="text" class="task-input" value="{{ task_text }}">

          <!-- ç¼–è¾‘ / ä¿å­˜ æŒ‰é’® -->
          <button type="button" class="edit-btn" onclick="event.preventDefault()">âœï¸</button>
          <button type="button" class="save-btn" style="display:none;" onclick="event.preventDefault()">âœ”ï¸</button>

          <!-- æ—¶é—´æˆ³ -->
          <span style="color:#aaa;font-size:0.9em;">{{ created_at }}</span>

          <!-- éšè—çš„æäº¤è¡¨å• -->
          <form method="POST" class="edit-form" style="display:none;">
            <input type="hidden" name="edit_task_id" value="{{ tid }}">
            <input type="hidden" name="edit_task_text" class="edit-text-hidden">
          </form>
        </li>
      {% endfor %}
    </ul>

    <!-- â€”â€” MISSION COMPLETE å½’æ¡£æŒ‰é’® â€”â€” -->
    {% set incomplete = tasks | selectattr('2', 'equalto', 0) | list %}
    {% if project[3] == 0 and incomplete|length == 0 and tasks|length > 0 %}
      <form method="POST">
        <button type="submit" name="complete">ğŸ‰ MISSION COMPLETE</button>
      </form>
    {% endif %}

    <div class="nav">
      <a href="{{ url_for('home') }}">â† è¿”å›ä»ªè¡¨ç›˜</a>
      <a href="{{ url_for('project_create') }}">â• æ–°å»ºé¡¹ç›®</a>
    </div>
  </div>

  <script>
    // â€”â€” é¡¹ç›®ç®€ä»‹ç¼–è¾‘é€»è¾‘ â€”â€” 
    const editProjBtn = document.querySelector('.edit-project-btn');
    const infoView    = document.querySelector('.info-view');
    const infoEdit    = document.querySelector('.info-edit');
    editProjBtn.addEventListener('click', ()=>{
      infoView.style.display = 'none';
      infoEdit.style.display = '';
    });

    // â€”â€” å­ä»»åŠ¡ç¼–è¾‘é€»è¾‘ â€”â€” 
    document.querySelectorAll('li[data-task-id]').forEach(li => {
      const editBtn = li.querySelector('.edit-btn');
      const saveBtn = li.querySelector('.save-btn');
      const label   = li.querySelector('.task-label');
      const input   = li.querySelector('.task-input');
      const form    = li.querySelector('.edit-form');
      const hidden  = form.querySelector('.edit-text-hidden');

      // è¿›å…¥ç¼–è¾‘æ€
      editBtn.addEventListener('click', e => {
        e.preventDefault();
        label.style.display   = 'none';
        input.style.display   = 'inline-block';  // â† æ˜¾å¼æ˜¾ç¤º
        editBtn.style.display = 'none';
        saveBtn.style.display = '';
      });

      // ç‚¹å‡»ä¿å­˜
      saveBtn.addEventListener('click', e => {
        e.preventDefault();
        const val = input.value.trim();
        if (!val) {
          alert('å­ä»»åŠ¡ä¸èƒ½ä¸ºç©º');
          return;
        }
        hidden.value = val;
        form.submit();
      });
    });
  </script>
</body>
</html>
